# @chauhaidang/xq-common-kit

Lightweight TypeScript utility library for XQ projects. Part of the `xq-toolbox` monorepo.

**Package**: `@chauhaidang/xq-common-kit` (v1.0.12)  
**Entry point**: `dist/index.js` (types: `dist/index.d.ts`)  
**License**: Apache-2.0  
**Registry**: GitHub Packages (`https://npm.pkg.github.com`)

---

## Directory Structure

```
packages/xq-common-kit/
├── src/
│   ├── index.ts            # Barrel export — re-exports all public API
│   ├── config.ts            # getConfig()
│   ├── logger.ts            # logger, LOG_LEVELS, Logger interface
│   ├── markdown.ts          # generateMarkdownFromJunit()
│   ├── string.ts            # generateRandomString()
│   ├── yaml.ts              # readYAML()
│   └── __tests__/
│       ├── config.test.ts
│       ├── logger.test.ts
│       ├── markdown.test.ts
│       ├── string.test.ts
│       └── yaml.test.ts
├── dist/                    # Compiled output (generated by `npm run build`)
├── package.json
├── tsconfig.json            # Extends ../../tsconfig.json
├── jest.config.js           # ts-jest, node environment
├── LICENSE
└── README.md
```

---

## Dependencies

| Dependency | Version | Used By | Purpose |
|---|---|---|---|
| `js-yaml` | ^4.1.0 | `yaml.ts` | Parse YAML files |
| `xml2js` | ^0.6.2 | `markdown.ts` | Parse JUnit XML for markdown conversion |

**Dev dependencies**: TypeScript 5.9+, Jest 30, ts-jest, ESLint with `@typescript-eslint`.

---

## Public API Reference

All exports come from `src/index.ts`. Import from the package root:

```typescript
import {
  generateRandomString,
  getConfig,
  readYAML,
  logger,
  LOG_LEVELS,
  type Logger,
  generateMarkdownFromJunit
} from '@chauhaidang/xq-common-kit';
```

### `getConfig()`

**Source**: [`src/config.ts`](src/config.ts)

```typescript
function getConfig(): any
```

| Aspect | Detail |
|---|---|
| **Parameters** | None |
| **Returns** | Parsed JSON object from `xq.json` |
| **Throws** | `Error('xq.json file does not exist!')` if file is missing |
| **Side effects** | Reads filesystem — looks for `xq.json` in `process.cwd()` |
| **Caching** | File is read once; subsequent calls return cached parse result |
| **Notes** | The raw `Buffer` is cached, but `JSON.parse()` runs on every call |

---

### `readYAML(filePath)`

**Source**: [`src/yaml.ts`](src/yaml.ts)

```typescript
function readYAML(filePath: string): any | null
```

| Aspect | Detail |
|---|---|
| **Parameters** | `filePath: string` — absolute or relative path to a `.yaml` / `.yml` file |
| **Returns** | Parsed YAML content (object, array, or primitive), or `null` on error |
| **Throws** | Never — errors are caught internally and logged to `console.error` |
| **Side effects** | Synchronous file read via `fs.readFileSync` |
| **Dependency** | `js-yaml` (`yaml.load`) |

---

### `generateRandomString(length)`

**Source**: [`src/string.ts`](src/string.ts)

```typescript
function generateRandomString(length: number): string
```

| Aspect | Detail |
|---|---|
| **Parameters** | `length: number` — desired string length |
| **Returns** | Random string of `[A-Za-z0-9]` characters |
| **Throws** | Never |
| **Side effects** | None (pure function, uses `Math.random`) |

---

### `logger` (singleton)

**Source**: [`src/logger.ts`](src/logger.ts)

```typescript
const logger: Logger
```

Singleton instance of `LoggerImpl`. Default log level is `INFO`.

#### `Logger` interface methods

| Method | Signature | Description |
|---|---|---|
| `setLevel` | `(level: string \| number) => void` | Set minimum log level. Accepts `'DEBUG'`, `'INFO'`, `'WARN'`, `'ERROR'` (case-insensitive) or numeric value |
| `debug` | `(message: string, ...args: any[]) => void` | Log at DEBUG level (level 0) |
| `info` | `(message: string, ...args: any[]) => void` | Log at INFO level (level 1) |
| `warn` | `(message: string, ...args: any[]) => void` | Log at WARN level (level 2) |
| `error` | `(message: string, ...args: any[]) => void` | Log at ERROR level (level 3) |

#### `LOG_LEVELS` constant

```typescript
const LOG_LEVELS = { DEBUG: 0, INFO: 1, WARN: 2, ERROR: 3 } as const
```

#### Output format

```
[ISO-8601-timestamp] LEVEL: message [stringified args]
```

- Output is ANSI-colored (cyan=DEBUG, green=INFO, yellow=WARN, red=ERROR)
- Object args are serialized with `JSON.stringify(arg, null, 2)`
- All output goes to `console.log` (including errors)

---

### `generateMarkdownFromJunit(xmlContent)`

**Source**: [`src/markdown.ts`](src/markdown.ts)

```typescript
async function generateMarkdownFromJunit(xmlContent: string): Promise<string>
```

| Aspect | Detail |
|---|---|
| **Parameters** | `xmlContent: string` — raw JUnit XML string |
| **Returns** | Markdown-formatted test report string |
| **Throws** | Propagates XML parse errors from `xml2js.parseStringPromise` |
| **Async** | Yes — returns a `Promise` |
| **Dependency** | `xml2js` (`parseStringPromise`) |

#### Generated markdown structure

```
# E2E Test Results
## Summary
  - Status, Total Tests, Passed, Failed, Errors, Duration
## Test Suites
### [status emoji] [Suite Name]
  - Duration, Tests count, Failed count
  - Passed tests (collapsed in <details>)
  - Failed tests with error details (expanded, first 10 lines, ANSI stripped)
```

#### Internal helpers (not exported)

- `formatDuration(seconds)` — formats seconds as `Xms` or `X.XXs`
- `parseJUnitXML(xmlContent)` — wraps `xml2js.parseStringPromise`

---

## Development Commands

All commands should be run from **this package directory** (`packages/xq-common-kit/`):

| Command | Description |
|---|---|
| `npm run build` | Compile TypeScript to `dist/` via `tsc` |
| `npm test` | Run Jest tests (`src/__tests__/**/*.test.ts`) |
| `npm run lint` | Lint with ESLint (`.ts` files) |
| `npm run lint:fix` | Auto-fix lint issues |
| `npm run clean` | Remove `dist/` directory |

### Build configuration

- **TypeScript**: Extends root `../../tsconfig.json`, outputs to `dist/`, generates declarations + declaration maps
- **Jest**: Uses `ts-jest` preset, node environment, tests match `**/__tests__/**/*.test.ts`
- **Excludes from build**: `node_modules`, `dist`, `*.test.ts`, `*.spec.ts`

---

## Installation

Requires `.npmrc` configuration for GitHub Packages:

```
@chauhaidang:registry=https://npm.pkg.github.com
```

Then install:

```sh
npm install @chauhaidang/xq-common-kit
```

---

## Publishing

Automatically published to GitHub Packages via monorepo CI when the `version` field in `package.json` changes.

---

## Common Patterns & Gotchas

1. **`getConfig()` depends on CWD** — It resolves `xq.json` relative to `process.cwd()`, not the file location. Ensure the working directory is correct when calling.
2. **`readYAML` swallows errors** — Returns `null` on failure instead of throwing. Always null-check the return value.
3. **Logger is a singleton** — Calling `setLevel()` affects all code using the logger in the same process.
4. **`generateMarkdownFromJunit` is async** — Must be `await`ed even though the underlying XML parsing is the only async operation.
5. **No tree-shaking for CJS** — The single entry point bundles everything. ESM consumers get proper tree-shaking via the `exports` field.
